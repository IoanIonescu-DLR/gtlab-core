########################################################
###########GTlab Pipeline Version 2.0.0 ###########
########################################################
# This is a slight changed version and 
# --> the nightly copy stage is currently missing
# --> contains a guiTests step
# --> executes copyBin.bat in copyForDeploymentWin and
#     copyForDeploymentLinux

# Environment variables to use in the pipeline globally
variables:
  PIPELINEVERSION: "2.0.0-unstable"
  GIT_SUBMODULE_STRATEGY: none
  # overriding the global config for now in this branch
  QT_DIR_LINUX:  "/opt/Qt/5.15.2/gcc_64/"
  QT_DIR_LINUX2: "/opt/Qt/5.15.2/gcc_64/"

# inlcude some templates from this file
include:
  - project: 'gtlab-bugtracking/gitlab-templates'
    file: '/ci-templates/.ci-templates.yml'
   
stages:
  - update
  - build
  - test
  - package
  - guiTestStable
  - guiTestUnstable
  - regressionTest
  - copy
  - codequality
  - badges

# Templates
.debugBuildRules:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: $CI_COMMIT_TAG == null
    - if: $CI_COMMIT_TAG =~ /^[1-9][0-9]*-[0-9]+-[0-9]+$/ # stable tag
    - if: $CI_COMMIT_TAG =~ /^[1-9][0-9]*-[0-9]+-[0-9]+-.*$/ # unstable tag

.releaseBuildRules:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: $CI_COMMIT_BRANCH == "master" # -master
    - if: $CI_COMMIT_TAG =~ /^[1-9][0-9]*-[0-9]+-[0-9]+$/ # stable tag
    - if: $CI_COMMIT_TAG =~ /^[1-9][0-9]*-[0-9]+-[0-9]+-.*$/ # unstable tag

# DevTools Update
devtoolsUpdateWindows:
  extends: .devToolsUpdateWindows
  stage: update
  only:
    - master  

devtoolsUpdateLinux:
  extends: .devToolsUpdateLinux
  stage: update
  only:
    - master  

.buildWindows:
  stage: build
  tags:
    - windows
    - docker
  image: dlr-at/gtlabdev-msvc-2019
  before_script:
    - '& $VCvarsall'
    - '& echo "Using Devtools: $DEVTOOLS"'
    - '& echo "Using QMake: $QMAKE_PATH"'
    - '& echo "Build-Config: $BUILDMODE"'
    - '& $MAINTENANCETOOL up --confirm-command; $null'
  script:
    - copy features\gitlab_pipeline_local_settings.pri local_settings.pri
    - '& $QMAKE_PATH $PROFILENAME -spec win32-msvc "CONFIG+=$BUILDMODE"'
    - '& $JOM_PATH'
  variables:
    MAINTENANCETOOL: "C:\\devel\\GTlab-DevTools\\Setup GTlab-DevTools.exe"
    VCvarsall: "C:\\devel\\vcvars2019_64.ps1"
    QMAKE_PATH: C:\\Qt\\Qt5.15\\5.15.2\\msvc2019_64\\bin\\qmake.exe
    JOM_PATH: C:\\Qt\\Qt5.15\\Tools\\QtCreator\\bin\\jom\\jom.exe
    GIT_SUBMODULE_STRATEGY: "recursive"
    GIT_STRATEGY: "clone"


# Windows build
windowsBuildDebug:
  stage: build
  extends: 
    - .debugBuildRules 
    - .buildWindows
  artifacts:
    paths:
      - lib/$TARGETDIRNAME/*-d.dll
      - lib/$TARGETDIRNAME/*-d.lib
      - build/*-d.pdb
      - build/GTlabGui-d.dll
      - build/GTlabGui-d.lib
      - build/$TARGETNAME.exe
      - build/GTlabConsole.exe
      - build/$UNITTESTSNAME.exe
      - build/$UNITTESTSNAME.pdb
      - include/$TARGETDIRNAME/*.h
    expire_in: 1 week
    when: always
  variables:
    BUILDMODE: debug
    BUILDUNITTESTS: "true"
    DEVTOOLS: $DEVTOOLS_Win_Unstable
    
windowsBuildRelease:
  stage: build
  extends: 
    - .releaseBuildRules
    - .buildWindows
  artifacts:
    paths:
      - lib/$TARGETDIRNAME/*.dll
      - lib/$TARGETDIRNAME/*.lib
      - include\$TARGETDIRNAME\*.h
      - build/GTlabGui.dll
      - build/GTlabGui.lib
      - build/$TARGETNAME.exe
      - build/GTlabConsole.exe
    expire_in: 1 week
    when: always
  variables:
    BUILDMODE: release
    BUILDUNITTESTS: "false"
    DEVTOOLS: $DEVTOOLS_Win_Unstable

# Linux build
linuxBuildDebug:
  stage: build
  extends: 
    - .debugBuildRules
    - .buildLinux 
  tags:
    - Linux
  artifacts:
    paths:
    - linuxBuild.txt
    - lib/$TARGETDIRNAME/*.so*
    - build/$TARGETNAME
    - build/GTlabConsole
    - build/*.so*
    - build/$UNITTESTSNAME
    - build/modules
    when: always
    expire_in: 1 week
  variables:
    BUILDMODE: debug
    BUILDUNITTESTS: "true"
    QMAKE_EXECUTABLE: $QT_DIR_LINUX2/bin/qmake
    DEVTOOLS: $DEVTOOLS_Linux_Unstable 

linuxBuildRelease:
  stage: build 
  extends: 
    - .releaseBuildRules
    - .buildLinux 
  tags:
    - Linux
  artifacts:
    paths:
    - lib/$TARGETDIRNAME/*.so*
    - build/$TARGETNAME
    - build/GTlabConsole
    - build/libGTlabGui.so*
    - include/$TARGETDIRNAME/*.h
    expire_in: 1 week
  variables:
    BUILDMODE: release
    BUILDUNITTESTS: "false"
    QMAKE_EXECUTABLE: $QT_DIR_LINUX2/bin/qmake
    DEVTOOLS: $DEVTOOLS_Linux_Unstable

# Template for the two GUI-Testing jobs
.guiTestTemplate:
  allow_failure: true
  before_script:
    # sync submodules
    - git submodule sync
    - git submodule update --init
    # add permissions
    - chmod +x ./tests/guitests/run_guitests.sh
  script:
    # xvfb to run a virtual display
    - xvfb-run -a ./tests/guitests/run_guitests.sh
  retry: 2
  artifacts:
    paths:
      - ./gui_tests_web
      - ./gui_tests_junits
      - ./gui_tests_stdout*.txt     
      - ./gui_tests_server_stdout.txt  
      - ./guitests_badge.svg
    reports:
      junit: ./gui_tests_junits/junit*.xml
    name: "guitesting results"
    expire_in: 1 week
    when: always

# GUI Testing
.guiTests:
  stage: guiTestStable
  extends: .guiTestTemplate  
  tags:
    - Linux
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: $CI_COMMIT_TAG == null
    - if: $CI_COMMIT_TAG =~ /^[1-9][0-9]*-[0-9]+-[0-9]+$/ # stable tag
  needs: 
      - linuxBuildDebug
      - job: "testLinux512"
        artifacts: false
  dependencies:
    - linuxBuildDebug
  variables:
    DEVTOOLS_DIR: $DEVTOOLS_Linux_Stable 

# GUI Testing Unstable
guiTestsUnstable:
  stage: guiTestUnstable
  extends: .guiTestTemplate
  tags:
    - Linux
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: $CI_COMMIT_TAG == null
  needs:
      - linuxBuildDebug
      - job: "testLinux512Unstable"
        artifacts: false
  dependencies:
    - linuxBuildDebug
  variables:
    DEVTOOLS_DIR: $DEVTOOLS_Linux_Unstable      

guiTestsUnstableTag:
  stage: guiTestUnstable
  extends: .guiTestTemplate
  tags:
    - Linux
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: $CI_COMMIT_TAG =~ /^[1-9][0-9]*-[0-9]+-[0-9]+-.*$/ # unstable tag
  needs:
      - linuxBuildDebug
      - job: "testLinux512Unstable"
        artifacts: false
  dependencies:
    - linuxBuildDebug
  variables:
    DEVTOOLS_DIR: $DEVTOOLS_Linux_Unstable

# run tests using the binary built before
.testWin512:
  extends: 
    - .winTestTemplate
    - .debugBuildRules
  needs: ["windowsBuildDebug"]
  dependencies: ["windowsBuildDebug"]
  variables:
    DEVTOOLS: $DEVTOOLS_Win_Stable

testWin512Unstable:
  extends: 
    - .winTestTemplate
    - .debugBuildRules
  needs: ["windowsBuildDebug"]
  dependencies: ["windowsBuildDebug"]
  variables:
    DEVTOOLS: $DEVTOOLS_Win_Unstable
    TESTRUNNER: .\tests\pipeline-scripts\unittests\runUnittestsQt515.bat

.testLinux512:
  extends: 
    - .linuxTestTemplate
    - .debugBuildRules
  needs: ["linuxBuildDebug"]
  dependencies:
    - linuxBuildDebug
  variables:
    DEVTOOLS: $DEVTOOLS_Linux_Stable    

testLinux512Unstable:
  extends: 
    - .linuxTestTemplate
    - .debugBuildRules
  needs: ["linuxBuildDebug"]
  dependencies: ["linuxBuildDebug"]
  variables:
    DEVTOOLS: $DEVTOOLS_Linux_Unstable   

valgrind:
  extends: 
    - .debugBuildRules
  needs: ["linuxBuildDebug"]
  dependencies: ["linuxBuildDebug"]
  stage: test
  before_script:
    - chmod +x ./tests/memcheck/runValgrind.sh
    - chmod +x ./tests/memcheck/post.py
    - python3 -m venv env
    - source env/bin/activate
  script:
    - xvfb-run -a ./tests/memcheck/runValgrind.sh
    - python3 ./tests/memcheck/post.py
  tags:
    - Linux
  artifacts:
    paths:
      - valgrind-report.xml
      - cpputest_valgrind.xml
    reports:
      junit: cpputest_valgrind.xml   
    expire_in: 1 week
  variables:
    DEVTOOLS: $DEVTOOLS_Linux_Unstable

# copy templates
.copyTemplate:
  script:
    - .\tests\build\copyHeaders-deployment.bat
    - .\tests\build\copyBin.bat
  tags:
    - Win10

.unstableTagTemplate:
  extends: .copyTemplate
  rules:
    - if: $CI_COMMIT_TAG =~ /^[1-9][0-9]*-[0-9]+-[0-9]+-.*$/
  variables:
    RELEASESTATUS: unstable

.stableTagTemplate:
  extends: .copyTemplate
  rules:
    - if: $CI_COMMIT_TAG =~ /^[1-9][0-9]*-[0-9]+-[0-9]+$/
  variables:
    RELEASESTATUS: stable

.package:
  stage: package
  tags:
    - Linux
  script:
    - mkdir pkg
    - mkdir pkg/$BINDIR
    - mv build/* pkg/$BINDIR
    # copy all runtime libs into bindir
    - mv lib/$TARGETDIRNAME/*.dll pkg/$BINDIR 2> /dev/null || `:`
    - cp lib/$TARGETDIRNAME/*.so pkg/$BINDIR 2> /dev/null || `:`
    # move include and libdir into package
    - mv lib/ include/ pkg/ 2> /dev/null || `:`
    # make sure all link libraries are in lib/core
    - mv pkg/$BINDIR/*.lib pkg/lib/$TARGETDIRNAME/ 2> /dev/null || `:`
    - cp pkg/$BINDIR/*.so pkg/lib/$TARGETDIRNAME/ 2> /dev/null || `:`
    - rm pkg/$BINDIR/$UNITTESTSNAME* 2> /dev/null || `:`
    # show package contents
    - find pkg/
  artifacts:
    paths:
    - pkg
  variables:
    BINDIR: bin

packageWinDebug:
  extends:
    - .package
    - .debugBuildRules 
  needs: ["windowsBuildDebug"]
  dependencies: ["windowsBuildDebug"]
  
  variables:
    BINDIR: binDebug

packageWinRelease:
  extends:
    - .package
    - .releaseBuildRules 
  needs: ["windowsBuildRelease"]
  dependencies: ["windowsBuildRelease"]


packageLinuxDebug:
  extends:
    - .package
    - .debugBuildRules 
  needs: ["linuxBuildDebug"]
  dependencies: ["linuxBuildDebug"]
  variables:
    BINDIR: binDebug


packageLinuxRelease:
  extends:
    - .package
    - .releaseBuildRules 
  needs: ["linuxBuildRelease"]
  dependencies: ["linuxBuildRelease"]

copyForDeploymentWinUnstable:
  stage: copy
  extends: .unstableTagTemplate
  needs: ["packageWinDebug", "packageWinRelease"]
  dependencies: ["packageWinDebug", "packageWinRelease"]
  variables:
    PLATFORMNAME:  windows
    DESTDIR: bin


copyForDeploymentLinuxUnstable:
  stage: copy
  extends: .unstableTagTemplate
  needs: ["packageLinuxRelease", "packageLinuxDebug"]
  dependencies: ["packageLinuxRelease", "packageLinuxDebug"]
  variables:
    PLATFORMNAME:  linux
    DESTDIR: bin

# code quality
codingstyle:
  stage: codequality
  extends: .codingStyleTemplate 
  except:
    - tags

cppcheck:
  stage: codequality
  extends: .cppCheckReportTemplateFunc
  variables:
    COMPARE_TO: master
   
pages:
  stage: badges
  extends: .pageTemplate 
  only:
    - master
    - tag

# badges
badges:
  stage: badges
  extends: .badgeTemplate 
  except:
    - tags
  dependencies: ["windowsBuildDebug", "linuxBuildDebug"]
    
